name: aws
on:
  pull_request: {}
  pull_request_review_comment:
    types: [created, edited]

jobs:
  AWS:
    runs-on: ubuntu-latest
    name: aws
    steps:

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
          github_token: ${{ github.token }}

      - name: Test AWS Credentials
        run: |
            aws sts get-caller-identity

      - name: Disassociate repository from CodeGuru (if exists)
        run: |
          ASSOCIATION_ARN=$(aws codeguru-reviewer list-repository-associations --query "RepositoryAssociationSummaries[?Name=='ServeRest-Actions'].AssociationArn" --output text)
          if [ "$ASSOCIATION_ARN" != "None" ]; then
            echo "Found existing association: $ASSOCIATION_ARN"
            aws codeguru-reviewer disassociate-repository --association-arn "$ASSOCIATION_ARN"
          else
            echo "No existing association found."
          fi

      - name: Associate repository to CodeGuru Reviewer
        run: |
          aws codeguru-reviewer associate-repository \
          --repository "GitHub" \
          --connection-arn arn:aws:codeguru-reviewer:us-east-2:311141518949:association:1074ec9e-4e7c-4873-9372-e80ba765b936:code-review:RepositoryAnalysis-CaioVasconcellos_ServeRest-Actions-main-989f4215-2a22-45e6-bac0-59a25c26e4c8 \
          --name "ServeRest-Actions"
          --owner "CaioVasconcellos"

      - name: Ensure S3 Bucket Exists
        run: |
          BUCKET_NAME="codeguru-reviewer-serverest-caio"
          if ! aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket does not exist, creating..."
            aws s3 mb "s3://$BUCKET_NAME" --region us-west-2
          else
            echo "Bucket exists."
          fi

      - name: Check for Existing CodeGuru Association
        id: check_association
        run: |
                ASSOCIATION_ARN=$(aws codeguru-reviewer list-repository-associations --query "RepositoryAssociationSummaries[?Name=='ServeRest-Actions'].AssociationArn" --output text)
                if [[ -n "$ASSOCIATION_ARN" ]]; then
                  echo "Found existing association: $ASSOCIATION_ARN"
                  echo "ASSOCIATION_ARN=$ASSOCIATION_ARN" >> $GITHUB_ENV
                else
                  echo "No existing association found."
                fi

      - name: CodeGuru Reviewer
        uses: aws-actions/codeguru-reviewer@v1.1
        with:
          build_path: target
          s3_bucket: codeguru-reviewer-serverest-caio

      - name: Upload review result
        if: ${{ github.event_name != 'push' }}
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: codeguru-results.sarif.json